name: Build and Deploy to Aliyun OSS

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: æ‹‰å– Python SDK
        run: |
          mkdir -p sdk
          git clone --depth 1 --branch main \
            https://github.com/Serverless-Devs/agentrun-sdk-python.git \
            sdk/python

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ç”Ÿæˆ API æ–‡æ¡£
        run: python3 scripts/generate_api_docs.py --sdk-path sdk/python

      - name: æ„å»ºé™æ€æ–‡æ¡£
        run: npm run build

      - name: é…ç½® ossutil
        run: |
          # ä¸‹è½½ ossutil
          curl -o ossutil64.zip https://gosspublic.alicdn.com/ossutil/1.7.18/ossutil-v1.7.18-linux-amd64.zip
          unzip -j ossutil64.zip ossutil-v1.7.18-linux-amd64/ossutil64
          chmod +x ossutil64
          
          # é…ç½® ossutil
          ./ossutil64 config \
            -e ${{ secrets.OSS_ENDPOINT }} \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}

      - name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ OSS
        run: ./ossutil64 cp -r build/ oss://${{ secrets.OSS_BUCKET }}/ -f

      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "âœ… æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ°é˜¿é‡Œäº‘ OSS"
          echo "ğŸŒ è®¿é—®åœ°å€: https://${{ secrets.OSS_BUCKET }}.${{ secrets.OSS_ENDPOINT }}"
